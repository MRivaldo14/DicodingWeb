(()=>{"use strict";const e="https://story-api.dicoding.dev/v1",t={async getStories(){try{const t=localStorage.getItem("token");if(!t)throw new Error("Token tidak ditemukan. Silakan login.");const a=await fetch(`${e}/stories`,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok){const e=await a.json();throw new Error(e.message||"Gagal memuat stories dari API.")}const n=await a.json();if(!Array.isArray(n.listStory))throw new Error("Format data stories tidak valid.");return n.listStory.map((e=>({id:String(e.id),name:e.name,description:e.description,photoUrl:e.photoUrl,createdAt:e.createdAt,lat:e.lat,lon:e.lon})))}catch(e){throw console.error("StoryModel.getStories error:",e),e}},async addStory(t){try{const a=localStorage.getItem("token");if(!a)throw new Error("Token tidak ditemukan. Silakan login.");const n=await fetch(`${e}/stories`,{method:"POST",headers:{Authorization:`Bearer ${a}`},body:t}),r=await n.json();return n.ok?(r.story&&r.story.id&&(r.story.id=String(r.story.id)),{success:!0,message:r.message||"Story berhasil ditambahkan!",data:r.story}):{success:!1,message:r.message||"Gagal mengirim story."}}catch(e){return console.error("StoryModel.addStory error:",e),{success:!1,message:e.message||"Terjadi kesalahan saat upload story."}}}},a=(e,t)=>t.some((t=>e instanceof t));let n,r;const o=new WeakMap,i=new WeakMap,s=new WeakMap;let l={get(e,t,a){if(e instanceof IDBTransaction){if("done"===t)return o.get(e);if("store"===t)return a.objectStoreNames[1]?void 0:a.objectStore(a.objectStoreNames[0])}return u(e[t])},set:(e,t,a)=>(e[t]=a,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function c(e){l=e(l)}function d(e){return"function"==typeof e?(t=e,(r||(r=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(m(this),e),u(this.request)}:function(...e){return u(t.apply(m(this),e))}):(e instanceof IDBTransaction&&function(e){if(o.has(e))return;const t=new Promise(((t,a)=>{const n=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",o),e.removeEventListener("abort",o)},r=()=>{t(),n()},o=()=>{a(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",r),e.addEventListener("error",o),e.addEventListener("abort",o)}));o.set(e,t)}(e),a(e,n||(n=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,l):e);var t}function u(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,a)=>{const n=()=>{e.removeEventListener("success",r),e.removeEventListener("error",o)},r=()=>{t(u(e.result)),n()},o=()=>{a(e.error),n()};e.addEventListener("success",r),e.addEventListener("error",o)}));return s.set(t,e),t}(e);if(i.has(e))return i.get(e);const t=d(e);return t!==e&&(i.set(e,t),s.set(t,e)),t}const m=e=>s.get(e),p=["get","getKey","getAll","getAllKeys","count"],g=["put","add","delete","clear"],y=new Map;function h(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(y.get(t))return y.get(t);const a=t.replace(/FromIndex$/,""),n=t!==a,r=g.includes(a);if(!(a in(n?IDBIndex:IDBObjectStore).prototype)||!r&&!p.includes(a))return;const o=async function(e,...t){const o=this.transaction(e,r?"readwrite":"readonly");let i=o.store;return n&&(i=i.index(t.shift())),(await Promise.all([i[a](...t),r&&o.done]))[0]};return y.set(t,o),o}c((e=>({...e,get:(t,a,n)=>h(t,a)||e.get(t,a,n),has:(t,a)=>!!h(t,a)||e.has(t,a)})));const f=["continue","continuePrimaryKey","advance"],b={},w=new WeakMap,v=new WeakMap,k={get(e,t){if(!f.includes(t))return e[t];let a=b[t];return a||(a=b[t]=function(...e){w.set(this,v.get(this)[t](...e))}),a}};async function*S(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const a=new Proxy(t,k);for(v.set(a,t),s.set(a,m(t));t;)yield a,t=await(w.get(a)||t.continue()),w.delete(a)}function E(e,t){return t===Symbol.asyncIterator&&a(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&a(e,[IDBIndex,IDBObjectStore])}c((e=>({...e,get:(t,a,n)=>E(t,a)?S:e.get(t,a,n),has:(t,a)=>E(t,a)||e.has(t,a)})));const I="stories",B=function(e,t,{blocked:a,upgrade:n,blocking:r,terminated:o}={}){const i=indexedDB.open(e,t),s=u(i);return n&&i.addEventListener("upgradeneeded",(e=>{n(u(i.result),e.oldVersion,e.newVersion,u(i.transaction),e)})),a&&i.addEventListener("blocked",(e=>a(e.oldVersion,e.newVersion,e))),s.then((e=>{o&&e.addEventListener("close",(()=>o())),r&&e.addEventListener("versionchange",(e=>r(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),s}("story-db",1,{upgrade(e){try{e.objectStoreNames.contains(I)||e.createObjectStore(I,{keyPath:"id"})}catch(e){console.error("‚ùå Gagal upgrade database:",e)}}}),D={async saveStory(e){try{if(!e||null==e.id)return console.warn("‚ö†Ô∏è Story tidak valid untuk disimpan:",e),!1;if(!e.userEmail)return console.warn("‚ö†Ô∏è Story tidak punya userEmail:",e),!1;const t=await B;return await t.get(I,e.id)?(console.warn("üõë Story sudah ada, tidak disimpan ulang:",e.id),!1):(await t.put(I,e),console.log("‚úÖ Story berhasil disimpan:",e),!0)}catch(e){return console.error("‚ùå Gagal menyimpan story:",e),!1}},async saveStories(e=[]){if(!Array.isArray(e))return console.warn("‚ö†Ô∏è Data bukan array saat saveStories"),!1;try{const t=(await B).transaction(I,"readwrite"),a=t.objectStore(I);for(const t of e)null==t?.id||"string"!=typeof t.id&&"number"!=typeof t.id||!t.userEmail?console.warn("‚ö†Ô∏è Story dilewati saat batch save:",t):await a.get(t.id)?console.warn("‚Ü™Ô∏è Lewatkan story duplikat saat batch save:",t.id):a.put(t);return await t.done,console.log("‚úÖ Semua story berhasil disimpan."),!0}catch(e){return console.error("‚ùå Gagal menyimpan stories:",e),!1}},async getAllStories(){try{const e=await B,t=await e.getAll(I);return console.log("üì¶ Semua story dari IndexedDB:",t),t}catch(e){return console.error("‚ùå Gagal mengambil semua story:",e),[]}},async getStoryById(e){try{if(null==e||"string"!=typeof e&&"number"!=typeof e)return console.warn("‚ö†Ô∏è ID tidak valid saat getStoryById:",e),null;const t=await B;return await t.get(I,e)}catch(t){return console.error(`‚ùå Gagal mengambil story ID ${e}:`,t),null}},async deleteStory(e){try{if(null==e||"string"!=typeof e&&"number"!=typeof e)return console.warn("‚ö†Ô∏è ID tidak valid saat deleteStory:",e),!1;const t=await B;return await t.delete(I,e),console.log(`üóëÔ∏è Story dengan ID ${e} berhasil dihapus.`),!0}catch(t){return console.error(`‚ùå Gagal menghapus story ID ${e}:`,t),!1}},async clearAllStories(){try{const e=await B;return await e.clear(I),console.log("üßπ Semua story berhasil dihapus."),!0}catch(e){return console.error("‚ùå Gagal menghapus semua story:",e),!1}}},T=D.saveStory,M=D,A={presenter:null,render(e){document.getElementById("app").innerHTML='\n      <section class="container">\n        <h2>Tambah Story</h2>\n        <form id="uploadForm" class="upload-form">\n          <input type="text" name="description" placeholder="Deskripsi..." required class="input-field"/>\n          <input type="file" name="photo" accept="image/*" required class="input-field"/>\n          <button type="submit" class="submit-btn">Upload</button>\n        </form>\n\n        <button id="testPushBtn" class="test-push-btn">Uji Push Notification</button>\n\n        <h2>Daftar Story</h2>\n        <div id="story-list" class="story-list"></div>\n        <div id="map" class="map-container"></div>\n      </section>\n    ';const t=document.getElementById("story-list");if(t.innerHTML="",e.forEach((e=>{const a=e.photoUrl||(e.photoBlob?URL.createObjectURL(e.photoBlob):""),n=document.createElement("article");n.className="story-item",n.innerHTML=`\n        <div class="story-card">\n          <img src="${a}" alt="Foto dari ${e.name||"User"}" class="story-img"/>\n          <div class="story-content">\n            <h3 class="story-title">${e.name||"User"}</h3>\n            <p class="story-description">${e.description}</p>\n            <small class="story-date">${new Date(e.createdAt).toLocaleString()}</small>\n            <button class="save-offline-btn" data-id="${e.id}">üíæ Simpan Offline</button>\n          </div>\n        </div>\n      `,t.appendChild(n)})),this.presenter,t.querySelectorAll(".save-offline-btn").forEach((t=>{t.addEventListener("click",(async t=>{const a=t.target.dataset.id,n=e.find((e=>e.id===a||e.id===Number(a)));if(n)try{const e=localStorage.getItem("userEmail")||"anonymous@example.com",t={...n,userEmail:e,id:"string"==typeof n.id?n.id:String(n.id)};console.log("Menyimpan ke IndexedDB:",t),await this.presenter.saveStoryOffline(t),alert("Cerita berhasil disimpan secara offline!")}catch(e){alert("Gagal menyimpan cerita offline."),console.error(e)}else alert("Cerita tidak ditemukan!")}))})),"undefined"!=typeof L){const t=L.map("map").setView([0,0],2);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Map data ¬© OpenStreetMap contributors"}).addTo(t),e.forEach((e=>{e.lat&&e.lon&&L.marker([e.lat,e.lon]).addTo(t).bindPopup(`<strong>${e.name||"User"}</strong><br>${e.description}`)}))}const a=document.getElementById("testPushBtn");a&&a.addEventListener("click",(async()=>{const e=await navigator.serviceWorker.ready,t=await e.pushManager.getSubscription();if(t)try{const e=await fetch("/api/push-test",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),a=await e.json();alert(a.message||"Notifikasi diuji.")}catch(e){console.error("Push test error:",e),alert("Gagal mengirim push notification uji coba.")}else alert("Belum subscribe push notification.")}))},init(){var e;this.presenter=(e=this,{loadStories:async()=>{try{const a=await t.getStories(),n=localStorage.getItem("userEmail")||"anonymous@example.com",r=a.map((e=>({...e,userEmail:n,id:"string"==typeof e.id?e.id:String(e.id)})));await M.saveStories(r),e.render(r)}catch(t){console.warn("Gagal ambil stories dari API, coba ambil dari IndexedDB...",t);const a=await M.getAllStories();e.render(a)}},uploadStory:async a=>{try{const n=await t.addStory(a);if(n.success){e.showUploadSuccess();const a=await t.getStories(),n=localStorage.getItem("userEmail")||"anonymous@example.com",r=a.map((e=>({...e,userEmail:n,id:"string"==typeof e.id?e.id:String(e.id)})));await M.saveStories(r),e.render(r)}else e.showUploadError(n.message||"Gagal upload story.")}catch(t){console.error("Error saat upload story:",t),e.showUploadError(t.message||"Terjadi kesalahan saat upload story.")}},saveStoryOffline:async e=>{try{if(!e.id)throw new Error("Story harus memiliki properti id");if("string"!=typeof e.id&&(e.id=String(e.id)),!await M.saveStory(e))throw new Error("Gagal menyimpan story di IndexedDB");return!0}catch(e){throw console.error("saveStoryOffline error:",e),e}}}),this.presenter.loadStories(),document.addEventListener("submit",(e=>{if(e.target&&"uploadForm"===e.target.id){e.preventDefault();const t=new FormData(e.target);this.presenter.uploadStory(t)}}))},showUploadSuccess(){alert("Story berhasil ditambahkan!"),this.presenter.loadStories()},showUploadError(e){alert("Gagal upload story: "+e)}},j={async login(e,t){const a=await fetch("https://story-api.dicoding.dev/v1/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),n=await a.json();if(n.error)throw new Error(n.message);return n.token&&(localStorage.setItem("token",n.token),console.log("‚úÖ Token berhasil disimpan:",n.token)),n}};async function P(){if("serviceWorker"in navigator&&"PushManager"in window)try{const e=await navigator.serviceWorker.register("/DicodingWeb/service-worker.js");if(console.log("‚úÖ Service Worker terdaftar:",e),"granted"!==await Notification.requestPermission())return void console.warn("‚ùå Izin notifikasi ditolak oleh pengguna.");const t=function(e){const t=(e+"=".repeat(1)).replace(/-/g,"+").replace(/_/g,"/"),a=atob(t);return new Uint8Array([...a].map((e=>e.charCodeAt(0))))}("BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"),a=await e.pushManager.getSubscription();a&&(await a.unsubscribe(),console.log("üîÅ Subscription lama dibatalkan."));const n=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t});console.log("‚úÖ Subscription baru berhasil dibuat:",n),await async function(e){try{const t=localStorage.getItem("token");if(!t)throw new Error("Token tidak ditemukan. Pastikan user sudah login.");const a=e.getKey("p256dh"),n=e.getKey("auth");if(!a||!n)throw new Error("Key subscription tidak valid.");const r={endpoint:e.endpoint,keys:{p256dh:btoa(String.fromCharCode(...new Uint8Array(a))),auth:btoa(String.fromCharCode(...new Uint8Array(n)))}},o=await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(r)});if(!o.ok){const e=await o.text();throw new Error(`Gagal mengirim subscription: ${e}`)}console.log("üì¨ Subscription berhasil dikirim ke server Dicoding.")}catch(e){console.warn("‚ùå Gagal mengirim subscription ke server Dicoding:",e.message)}}(n)}catch(e){console.error("‚ùå Gagal mendaftarkan Service Worker atau melakukan subscription:",e)}else console.warn("‚ùå Browser tidak mendukung Service Worker atau Push Notification.")}const U={render(){document.getElementById("app").innerHTML='\n      <section>\n        <h2>Login</h2>\n        <form id="loginForm">\n          <label for="email">Email:</label>\n          <input id="email" type="email" required />\n          \n          <label for="password">Password:</label>\n          <input id="password" type="password" required minlength="8" />\n          \n          <button type="submit">Login</button>\n        </form>\n        <p>Belum punya akun? <a href="#/register">Daftar</a></p>\n      </section>\n    '},init(){const e=(t=this,{loginUser:async(e,a)=>{try{const n=await j.login(e,a);localStorage.setItem("token",n.loginResult.token);try{await P()}catch(e){console.warn("Push notification init error:",e)}t.showSuccessMessage("Login berhasil!")}catch(e){t.showErrorMessage(e.message||"Gagal login.")}}});var t;document.getElementById("loginForm").addEventListener("submit",(t=>{t.preventDefault();const a=document.getElementById("email").value,n=document.getElementById("password").value;e.loginUser(a,n)}))},showSuccessMessage(e){alert(e),location.hash="#/home"},showErrorMessage(e){alert(e)}},x={async register(e,t,a){const n=await fetch("https://story-api.dicoding.dev/v1/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:t,password:a})});if(!n.ok){const{message:e}=await n.json();throw new Error(e)}return await n.json()}},$=async()=>{const e=document.getElementById("app"),t=(a={showSuccessMessage:e=>alert(e),showErrorMessage:e=>alert(e)},{registerUser:async(e,t,n)=>{try{const r=await x.register(e,t,n);r.error?a.showErrorMessage(r.message):(a.showSuccessMessage(r.message),location.hash="#/login")}catch(e){a.showErrorMessage("Terjadi kesalahan saat mendaftar.")}}});var a;e.innerHTML='\n    <h2>Daftar Akun</h2>\n    <form id="registerForm">\n      <label for="name">Nama:</label>\n      <input type="text" id="name" required />\n      <label for="email">Email:</label>\n      <input type="email" id="email" required />\n      <label for="password">Password:</label>\n      <input type="password" id="password" required />\n      <button type="submit">Daftar</button>\n    </form>\n  ',document.getElementById("registerForm").addEventListener("submit",(e=>{e.preventDefault();const a=document.getElementById("name").value,n=document.getElementById("email").value,r=document.getElementById("password").value;t.registerUser(a,n,r)}))},C={async addStory(e){const t=localStorage.getItem("token");if(!t)throw new Error("Autentikasi gagal. Silakan login kembali.");try{const a=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:e});if(!a.ok){const e=await a.json();throw new Error(e.message||"Gagal menambahkan story.")}return await a.json()}catch(e){throw new Error(e.message||"Terjadi kesalahan jaringan. Silakan coba lagi.")}}},O=async e=>{document.getElementById("app").innerHTML='\n    <section class="add-story">\n      <h2><i class="feather icon-plus-circle"></i> Tambah Story Baru</h2>\n      <form id="storyForm">\n        <label for="description">Deskripsi:</label>\n        <textarea id="description" name="description" placeholder="Masukkan deskripsi..." required></textarea>\n\n        <fieldset>\n          <legend>Ambil Foto dengan Kamera</legend>\n          <div class="camera-wrapper">\n            <video id="video" autoplay playsinline></video>\n            <canvas id="canvas" style="display:none;"></canvas>\n            <button type="button" id="captureBtn" class="btn capture-btn" title="Ambil gambar dari kamera">\n              <i class="feather icon-camera"></i> Ambil Gambar\n            </button>\n            <img id="preview" src="" alt="Pratinjau hasil foto dari kamera" title="Pratinjau foto" class="preview" style="display:none;" />\n          </div>\n        </fieldset>\n\n        <label for="fileUpload">Atau unggah foto dari galeri:</label>\n        <input type="file" id="fileUpload" name="photo" accept="image/*" title="Unggah foto dari galeri" class="input-field" />\n\n        <input type="hidden" id="lat" name="lat">\n        <input type="hidden" id="lon" name="lon">\n\n        <div id="map" class="map-container"></div>\n\n        <button type="submit" class="btn submit-btn">Kirim</button>\n      </form>\n      <a href="#/home" class="back-link">‚¨Ö Kembali</a>\n    </section>\n  ';let t=null,a=null,n=null;const r={showSuccessMessage:e=>{const t=document.querySelector(".add-story"),a=document.createElement("div");a.className="success-banner",a.textContent=e,t.prepend(a),setTimeout((()=>a.remove()),2e3)},showErrorMessage:e=>{const t=document.querySelector(".add-story"),a=document.createElement("div");a.className="error-banner",a.textContent=e,t.prepend(a),setTimeout((()=>a.remove()),2e3)},cleanup:()=>{t&&(t.getTracks().forEach((e=>e.stop())),t=null),n&&(n.off(),n.remove(),n=null),c.removeEventListener("click",m),d.removeEventListener("submit",y),u.removeEventListener("change",p)}},o=(e=>({submitStory:async t=>{try{const a=await C.addStory(t),n=t.get("description"),r=t.get("photo"),o=t.get("lat")||null,i=t.get("lon")||null,s={id:Date.now().toString(),description:n,photo:r,lat:o,lon:i};await T(s),e.showSuccessMessage(a.message||"Story berhasil ditambahkan!"),e.cleanup(),setTimeout((()=>{location.hash="#/home"}),300)}catch(t){console.error("Error submit story:",t),e.showErrorMessage(t.message||"Terjadi kesalahan saat mengirim story.")}}}))(r),i=document.getElementById("video"),s=document.getElementById("canvas"),l=document.getElementById("preview"),c=document.getElementById("captureBtn"),d=document.getElementById("storyForm"),u=document.getElementById("fileUpload");function m(){s.width=i.videoWidth,s.height=i.videoHeight,s.getContext("2d").drawImage(i,0,0),s.toBlob((e=>{l.src=URL.createObjectURL(e),l.style.display="block",l.blob=e}),"image/jpeg")}function p(e){const t=e.target.files[0];t&&(l.src=URL.createObjectURL(t),l.style.display="block",l.blob=t)}if(navigator.mediaDevices.getUserMedia({video:!0}).then((e=>{t=e,i.srcObject=e})).catch((()=>{alert("Gagal mengakses kamera. Pastikan izinnya diberikan.")})),c.addEventListener("click",m),u.addEventListener("change",p),!document.querySelector('link[href*="leaflet.css"]')){const e=document.createElement("link");e.rel="stylesheet",e.href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css",document.head.appendChild(e)}function g(){n=L.map("map").setView([-6.9,107.6],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap contributors"}).addTo(n),n.on("click",(e=>{const{lat:t,lng:r}=e.latlng;document.getElementById("lat").value=t,document.getElementById("lon").value=r,a&&a.remove(),a=L.marker([t,r]).addTo(n)}))}if(window.L)g();else{const e=document.createElement("script");e.src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js",e.onload=g,document.body.appendChild(e)}function y(e){e.preventDefault();const t=document.getElementById("description").value.trim(),a=document.getElementById("lat").value,n=document.getElementById("lon").value,r=l.blob;if(!t)return void alert("Deskripsi harus diisi.");if(!r)return void alert("Ambil atau unggah gambar terlebih dahulu!");const i=new FormData;i.append("description",t),i.append("photo",r),a&&n&&(i.append("lat",a),i.append("lon",n)),o.submitStory(i)}d.addEventListener("submit",y),"function"==typeof e&&e(r.cleanup)},G={async getStoryDetail(e){const t=localStorage.getItem("token"),a=await fetch(`https://story-api.dicoding.dev/v1/stories/${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)throw new Error("Gagal memuat detail story (HTTP Error).");const{story:n,error:r,message:o}=await a.json();if(r)throw new Error(o||"Gagal memuat detail story.");return n}},H={render(){document.getElementById("app").innerHTML="<p>Memuat detail cerita...</p>"},init(){},renderDetail(e){if(document.getElementById("app").innerHTML=`\n      <section>\n        <h2>${e.name}</h2>\n        <img src="${e.photoUrl}" alt="Foto oleh ${e.name}" width="300"/>\n        <p>${e.description}</p>\n        <p><strong>Tanggal:</strong> ${new Date(e.createdAt).toLocaleString()}</p>\n        <div id="map" style="height:300px; margin-top:1rem;"></div>\n        <a href="#/home">‚¨Ö Kembali</a>\n      </section>\n    `,e.lat&&e.lon){const t=L.map("map").setView([e.lat,e.lon],13);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"¬© OpenStreetMap contributors"}).addTo(t),L.marker([e.lat,e.lon]).addTo(t).bindPopup(`<b>${e.name}</b><br>${e.description}`).openPopup()}},showErrorMessage(e){document.getElementById("app").innerHTML=`<p style="color:red;">${e}</p>`}};function N(){document.getElementById("app").innerHTML='\n    <section class="not-found">\n      <h2>404 Not Found</h2>\n      <p>Halaman yang Anda cari tidak ditemukan.</p>\n      <a href="#/home" class="btn btn-primary">Kembali ke Beranda</a>\n    </section>\n  '}const q={render:async()=>'\n      <section class="saved-stories">\n        <h2><i class="feather icon-archive"></i> Cerita Tersimpan (Offline)</h2>\n        <div id="storiesContainer" class="stories-container"></div>\n        <button id="clearAllBtn" class="btn danger">üóëÔ∏è Hapus Semua</button>\n        <a href="#/home" class="back-link">‚¨Ö Kembali</a>\n      </section>\n    ',async afterRender(){const e=document.getElementById("storiesContainer"),t=document.getElementById("clearAllBtn"),a=localStorage.getItem("userEmail"),n=async()=>{const t=(await M.getAllStories()).filter((e=>e.userEmail===a));e.innerHTML="",t.length?(t.forEach((t=>{const a=t.photoUrl||(t.photoBlob?URL.createObjectURL(t.photoBlob):"default-image.jpg"),n=document.createElement("div");n.className="story-card",n.innerHTML=`\n          <img src="${a}" alt="Foto cerita"\n               onerror="this.onerror=null;this.src='default-image.jpg';" />\n          <p><strong>Deskripsi:</strong> ${t.description}</p>\n          ${t.lat&&t.lon?`<p><strong>Lokasi:</strong> ${t.lat}, ${t.lon}</p>`:""}\n          <button class="delete-btn" data-id="${t.id}">Hapus</button>\n        `,e.appendChild(n)})),e.querySelectorAll(".delete-btn").forEach((e=>{e.addEventListener("click",(async e=>{const t=e.target;t.disabled=!0;const a=t.dataset.id,r=Number(a);isNaN(r)||(await M.deleteStory(r),await n()),t.disabled=!1}))}))):e.innerHTML='<p class="empty">Belum ada cerita Anda yang disimpan offline.</p>'};t.addEventListener("click",(async()=>{if(confirm("Yakin ingin menghapus semua cerita Anda yang tersimpan?")){t.disabled=!0;const e=await M.getAllStories();console.log("Semua cerita di IndexedDB:",e);const r=e.filter((e=>e.userEmail===a));console.log("Cerita user yang cocok:",r);for(const e of r)await M.deleteStory(e.id);await n(),t.disabled=!1,alert("Semua cerita Anda berhasil dihapus.")}})),await n()}};let F=null;function K(e){F=e}async function V(){const e=document.getElementById("app");if(!e)return;"function"==typeof F&&(F(),F=null),e.classList.remove("fade-in"),e.classList.add("fade-out"),await new Promise((e=>setTimeout(e,200)));const t=(location.hash||"#/home").split("/");switch(t[1]){case"":case"home":await async function(){try{A.init()}catch(e){console.error("‚ùå Error saat memuat halaman beranda:",e),A.showUploadError("Gagal memuat cerita. Silakan coba lagi.")}}((M.getAllStories,M.deleteStory));break;case"login":await(U.render(),void U.init());break;case"register":await $();break;case"add":await O(K,M.saveStory);break;case"story":t[2]?await async function(e){H.render();const t=(a=H,{loadDetail:async e=>{try{const t=await G.getStoryDetail(e);await M.saveStory(t),a.renderDetail(t)}catch(t){console.warn("Gagal ambil dari API, mencoba ambil dari IndexedDB...",t);const n=await M.getStoryById(e);n?a.renderDetail(n):a.showErrorMessage(t.message||"Gagal memuat detail cerita.")}}});var a;await t.loadDetail(e),H.init()}(t[2]):N();break;case"favorites":case"saved":e&&(e.innerHTML=await q.render(),await q.afterRender());break;default:N()}!function(){const e=document.getElementById("auth-links"),t=localStorage.getItem("accessToken");e&&(t?(e.innerHTML='<button id="logoutBtn" aria-label="Logout">Logout</button>',document.getElementById("logoutBtn")?.addEventListener("click",(()=>{localStorage.removeItem("accessToken"),alert("Anda telah logout."),location.hash="#/login"}))):e.innerHTML='\n      <a href="#/login" aria-label="Masuk">Masuk</a> |\n      <a href="#/register" aria-label="Daftar">Daftar</a>\n    ')}(),e.classList.remove("fade-out"),e.classList.add("fade-in")}function W(){"startViewTransition"in document?document.startViewTransition((()=>V())):V()}window.addEventListener("hashchange",W),window.addEventListener("DOMContentLoaded",(()=>{document.getElementById("app")?.animate([{opacity:0,transform:"translateY(20px)"},{opacity:1,transform:"translateY(0)"}],{duration:400,easing:"ease-in-out",fill:"forwards"}),W(),function(){const e=document.querySelector("#main-content"),t=document.querySelector(".skip-link");e&&t&&t.addEventListener("click",(a=>{a.preventDefault(),t.blur(),e.setAttribute("tabindex","-1"),e.focus(),e.scrollIntoView({behavior:"smooth"})}))}(),P()}))})();